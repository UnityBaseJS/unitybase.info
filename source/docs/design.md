title: Design
date: 2016-04-08 17:43:24
---
## Теория
В основу построения приложения для UB положен принцип [предметно-ориентированного проектирования](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%BD%D0%BE-%D0%BE%D1%80%D0%B8%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5) **(DDD) ** - создание программных абстракций, которые _моделируют предметную область_ и включают в себя сложную бизнес-логику, устраняющую промежуток между реальными условиями области применения продукта и кодом.  

## Модели
В большинстве систем масштаба предприятия используются крупномасштабные зоны ответственности. В UnityBase этот уровень абстракции называется **моделями**. Например, учетная система крупной корпорации может иметь следующие модели: 

- "Безопасность"
- "Администрирование"
- "Орг. структура"
- "Общие справочники"
- "Биллинг"
- "Рассылка уведомления"
- "Интеграция с ERP"

При проектировании система ведения организационной структуры и система безопасности выделяются как совершенно разные вещи. Приложения, в которых при реализации не удаётся разделить и изолировать бизнес-логику в модели с четко ограниченной функциональностью, часто приобретают архитектурный стиль, который имеет красноречивое название «Большой ком грязи».

{% note info %}
В UB модели представлены в виде папок на сервере.
{% endnote %}

## Сущности
Модель состоит из набора  _сущностей_. Например, модель "Орг. структура" состоит из сущностей "Организационная единица", "Организация", "Подразделение", "Сотрудник", "Назначение" итд. Проще всего о сущностях думать как о существительных. У сущноси есть _индивидуальность_ - **набор атрибутов**. 

Например, для сущности "Сотрудник" стоит определить атрибуты:

 - "Фамилия", 
 - "Имя", 
 - "Отчество", 
 - "Дата рождения"
 
а для сущности "Назначение":
- "Дата с"
- "Дата по", 
- "Организационная единица"
- "Сотрудник". 

{% note info %}
Описание сущности хранится в метафайле - `кодСущности.meta` в формате JSON и располагается в папке модели 
{% endnote %}

## Поведение
Каждая сущность обладает _поведением_ - набором методов. О _методах_ стоит думать как о глаголах. Сущность "Сортудник" должна уметь:
 - _сохранить_ свои изменения
 - _удалить_ себя из списка
 - _создать_ шаблон для добавления нового сотрудника со значениями по умолчанию

У сущности "Организационная единица" должен быть метод _расформировать_.   

{% note info %}
Методы сущности хранятся в JavaScript файле `кодСущности.js` рядом с метафайлом
{% endnote %}


## Миксины
Очевидно, что существует ряд общих _поведений_ у сущностей. Например, и "Сотрудник" и "Назначение" должны уметь сохранятся в БД, желательно учитывать историю изменения как фамилии сотрудника, так и периода назначения, обе сущности желательно не удалять напрямую, а лишь помечать на удаление. Так же администратору системы нужно знать историю выполнения операций над сущностями - кто, когда, с какого рабочего места и что модифицировал/удалял/добавлял.

В UB реализация методов, общих для множества сущностей вынесена в **[Миксины](https://en.wikipedia.org/wiki/Mixin)** (примеси). Например, миксин "mStorage" добавляет к любой сущности методы:
 - `select` - загрузить из БД
 - `insert` - сохранить в  БД
 - `update` - обновить значение атрибутов в БД
 - `delete` - удалить екземпляр из БД
 - `addNew` - создать новый екземпляр со значениями по умолчанию
 
  
{% note info %}
Кроме ускорения процесса проектирования и разработки, применение технологии примесей обеспечивает **единообразие в подходах**, что в результате существенно влияет на совокупную стоимость владения ПО. Как за счет сопровождаемости - любой член команды разработки может сопровождать код, написанный другими, так и за счет снижения требований к обучению.
{% endnote %}

Стандартная поставка платформы включает следующие миксины:

##### mStorage - ORM
Добавляет сущности CRUID методы, обеспечивает функционал мягкого удаления и оптимистической блокировки.  
    
##### audit - аудит уровня записи
Обеспечивает запись всех CRUID операций над сущносями в сущность аудита **ubs_audit**. 
 
##### rls - безопастность уровня записей
RLS is a security feature which allows developers to give access to a sub-set of data in their entity to others

##### aclRls - Access Control List Row Level Security
Безопастность уровня записей на базе списков контроля доступа.
[Access Control List](https://en.wikipedia.org/wiki/Access_control_list)

##### als - Attribute Level Security
Безопастность уровня атрибутов. Позволяет определить перечень доступных на просмотр/редактирование атрибутов екземпляра сущности на основании текущего состояния и активного пользователя.
  
##### dataHistory - историчность записей
Обеспечивает ведение истори изменения атрибутов сущности.
  
##### unity - емуляция наследования
Емулирует объектно-ориентированную концепцию "наследования" на реляционной СУБД
   
##### tree - древовидные структуры
Позволяет хранить древовидные структуры в плоском представлении с построением хранимого пути   

##### fts - полнотекстовое индексирование
Посторение полнотекстовых индексов на базе значений из атрибутов сущности

##### softLock - песcимистические блокировки
Pessimistic Lock

##### clobTruncate - Обрезает большие текстовые поля 


{% note info %}
Начиная с версии UB 2.0 разработчик может создавать собственные миксины.
{% endnote %}

## Метаданные
Совокупность всех сущностей, описанных в модели предметной области является **метаданными**. Клиентские приложения могут использовать метаданные для автоматический генерации частей пользовательского интерфейса (так делает `adminUI`), генерации докумнетации, построения ER диаграм, генерации DML для СУБД и.т.д. 

Сервер приложений на основе метаданных обеспечивает универсальный доступ к методам сущностей  - **API**. Другими словами
{% note info %}
серверу достаточно метафайла сущности для генерации API взаимодействия с этой сущностью.
{% endnote %}

## REST API

, или при этом начинает создаваться или извлекаться новая сущность. В более слабом коде можно найти массу служебных или управляющих классов, проверяющих сущности снаружи

На основании декларативного описания сущностей модели предметной области сервер приложений:

 - генерирует [слой доступа к БД](https://en.wikipedia.org/wiki/Data_access_layer) и структуру БД
 - реализует REST API для доступа с сущностям предметной области

Бизнес-логика серверных сущностей реализуется на встроенном JavaScript, что позволяет использовать единый язык как для серверной, так и для ВЕБ части приложеня.

Подход DDD в свою очередь позволяет структурировать большой проект и унифицировать интерфейсы взаимодействия между частями системы, что существенно упрощает как разработку сложных (тысячи и более сущностей) приложений, так и их дальнейшее сопровождение.

Cостоит из: 

- сервера приложений - **асинхронный** HTTP сервер со встроенным **синхронным** многопоточным интерпретатором JavaScript, ORM c поддержкой транзакционных промышленных СУБД (Oracle, SQL Server, PostgreSQL) и файловым хранилищем. Функциональность сервера расширяется модулями, написанными на JavaScript либо С/С++.

- административного интерфейа - веб приложение с поддержкой автогенерации/декларативного описания интерфейса пользователя, позволяющее создавать _интранет_ приложения неограниченного уровня сложности

- библиотек транспортного уровня - набор библиотек для основных языков програмирования, облегчающих работу с сервером приложений:

	- `ub-core.js` - для создания HTML5 SPA приложений c использованием любого клиентского фреймворка (`React`, `Angular`, `Vue`, и.т.д) 
    - библиотеки для `.Net`, `PHP`, `VBA (excel)`, `iOS`, `Android`.

Внешний интерфейс сервера приложений полностью построен на REST API, что позволяет полнофункционально и бесшовно интерировать решение на основе UB с любым другим продуктом, поддерживающим протокол HTTP.